themes = ["Demography", "Food and Drinks", "Health and Wellness", "Home", "Lifestyle", "Location", "Media", "Media Usage", "Professional Life", "Segments", "Shopping"]
categories = {
    "Demography": [
        "Demographics",
        "Education",
        "Household Composition",
        "Household Status",
        "Language",
        "Marriage / Partnership",
        "Psychographics",
        "Workplace"
    ],
    "Food and Drinks": [
        "Beer",
        "Beer / Wine / Liquor / Spirits",
        "Bourbon",
        "Chewing Gum",
        "Chewy / Gummy Candies",
        "Chocolate / Candy Bars",
        "Cider",
        "Cocktail Mixers (Pre-Mixed)",
        "Coffee",
        "Cognac",
        "Coolers",
        "Cordials & Liqueurs",
        "Corn / Tortilla Chips & Cheese Snacks",
        "Energy / Sport Drinks",
        "Flavoured Beverage Enhancers (e.g. Mio)",
        "Fruit Drinks / Punches",
        "Gin",
        "Hard Candy / Mints",
        "Iced Tea / Kombucha",
        "Irish Whiskey",
        "Kids Snacks",
        "Meat Snacks",
        "Non-Carbonated Bottled Water",
        "Nuts / Seeds",
        "Popcorn",
        "Potato Chips",
        "Prepared Mixed Drinks With Liquor",
        "Pretzels",
        "Ready to Drink Cold Coffee (Can or Bottle)",
        "Restaurant Visits",
        "Rice Cakes / Corn Cakes / Potato Crisps",
        "Rum",
        "Rye / Canadian Whisky",
        "Scotch Whisky",
        "Seltzer / Vodka Soda",
        "Snack / Party Mix",
        "Soft Drinks / Colas",
        "Sparkling Water",
        "Spirits / Liquor",
        "Tea",
        "Tequila",
        "Vodka",
        "Wine"
    ],
    "Health and Wellness": [
        "Acne Products",
        "Allergy & Sinus Remedies",
        "Antifungal Products",
        "Blush",
        "Body Wash",
        "Brow and Eye Liner",
        "Children's Cough & Cold Remedies",
        "Cold Remedies",
        "Cosmetic Treatments",
        "Cough Drops",
        "Cough Syrup",
        "Denture Adhesive",
        "Denture Cleansers",
        "Dentures",
        "Deodorants / Antiperspirants",
        "Diet Control / Weight Management",
        "Eye Drops",
        "Eyewear",
        "Face & Body Skincare",
        "Facial Cleansers",
        "Facial Moisturizers",
        "Feminine Hygiene Products",
        "Foot Grooming",
        "Foot Odour / Wetness",
        "Foundation Make",
        "Hair Colouring Products",
        "Hair Conditioners",
        "Hair Growth Products",
        "Hair Mousses / Gels / Sprays",
        "Hair Removal",
        "Hair Salon",
        "Hand & Body Cream / Lotion",
        "Health Care",
        "In-Home Pregnancy Test",
        "Laser Eye Surgery",
        "Laxatives",
        "Lip Care",
        "Lipstick / Lipliner / Lipgloss",
        "Make",
        "Mascara",
        "Medical Conditions / Prescription Remedies",
        "Menopause Remedies",
        "Mouthwash / Dental Rinse",
        "Multi",
        "Nail Care Products & Polish",
        "Nail Salon",
        "Nasal Spray",
        "Natural Based Cough and Cold Remedies",
        "Non-Prescription Products For Preventing Heart Attack / Stroke",
        "Pain Relievers",
        "Pain Relievers For Arthritis / Rheumatism",
        "Pain Relievers For Back Pain",
        "Pain Relievers For Headaches",
        "Pain Relievers For Muscle / Body Pain",
        "Perfume & Cologne",
        "Pre-Menstrual / Period Pain Remedies",
        "Saline Nasal Spray",
        "Shampoo",
        "Smoking Products",
        "Sore Throat Remedies",
        "Suntan & Sunscreen Products",
        "Tooth Whitening Systems",
        "Toothbrushes",
        "Toothpaste",
        "Upset Stomach Remedies",
        "Vitamins, Minerals, Herbal & Nutritional Supplements",
        "Wart Treatments",
        "Yeast Infection Products"
    ],
    "Home": [
        "Building / Home Improvement Items / Tools",
        "Coffee Machine",
        "Furniture and Home Accessories",
        "Gardening",
        "Home Electronics / Entertainment Products",
        "Home Heating",
        "Home Improvements",
        "Household Appliances & Durables",
        "Paint and Stain",
        "Real Estate",
        "Video Games",
        "Weekend / Vacation Home",
        "Your Home"
    ],
    "Lifestyle": [
        "Vehicles / Makes / Models",
        "Airlines / Aeroports",
        "Attractions",
        "Auto Insurance",
        "Automotive Services / Supplies / Products",
        "Betting Games",
        "Business Travel",
        "Car, Truck Or SUV Rental",
        "Casinos",
        "Children In Sports",
        "Cruise Ships",
        "Electric Vehicles",
        "Events: Personally Attended / Visited Past 12 Mths",
        "Fitness Club",
        "Hotels and Motels",
        "Intent to Purchase / Lease Vehicle / Motorcycle",
        "Leisure Activities Past Month",
        "Leisure Activities: Personally Attend",
        "Leisure Activities: Personally Participate",
        "Lottery Tickets",
        "Lottery, Casino and Consumer Shows",
        "Mileage",
        "Movies",
        "Packages / Tour Operators / Arrangements / Websites",
        "Public Activities",
        "Restaurants / Bars / Fast Food",
        "Roadside Assistance Programs",
        "Sports & Recreation Equipment / Goods",
        "Sports / Entertainment Venues: Personally Visited Past 12 Mos",
        "Taxis",
        "Tires",
        "Travel in Canada",
        "Travel Insurance",
        "Travel Outside Canada",
        "Vacation / Personal Travel",
        "Vehicle Maintenance for Most Recently Acquired Vehicle",
        "Vehicle Ownership / Purchase for Most Recently Acquired Vehicle",
        "Vehicle Type / Country of Origin",
    ],
    "Location": [
        "Geography",
    ],
    "Media": [
        "Flyers and Out Of Home Usage",
        "Internet Usage",
        "Magazine Usage",
        "Newspaper Usage",
        "Radio Usage",
        "Television Usage"
    ],
    "Media Usage": [
        "Internet / Social Media"
    ],
    "Professional Life": [
        "Banking & Financial Services",
        "Business Purchase Involvement",
        "Business Purchasing / Leasing Decisions",
        "Credit Cards",
        "Crypto Currency",
        "Donations",
        "Financial Planner / Advisor Services",
        "Home Office / Business",
        "Homeowners Or Personal Property Insurance",
        "Life Insurance",
        "Loan / Line Of Credit",
        "Mobile Banking (using smartphone / tablet)",
        "Mobile Wallet / Mobile Payment Systems",
        "Mortgages",
        "Mutual Funds",
        "Online Banking",
        "Online Trading / Brokerage / Investments",
        "Private Health Insurance",
        "RRSP's",
        "Stocks / Bonds",
        "TFSA (Tax Free Savings Account)",
        "Total Investments And Savings",
        "Wills / Estate Planning"
    ],
    "Segments": [
        "Arima"
    ],
    "Shopping": [
        "Air Fresheners, Carpet & Room Deodorizers",
        "All Purpose Household Cleaners",
        "Automatic Dishwasher Detergent",
        "Baking Chips",
        "Baking Ingredients",
        "Bathroom Cleaners",
        "Books",
        "Bottled Seasoning Sauce",
        "Boxed Chocolates",
        "Boxed Dried Macaroni & Cheese",
        "Bread",
        "Breakfast Sandwiches",
        "Butter",
        "Canned Food",
        "Carpet & Rug Cleaners",
        "Cat Food",
        "Cat Food",
        "Children's Clothing / Shoes",
        "Children's Products",
        "Chocolate Milk",
        "Cold Cereals",
        "Convenience Stores",
        "Cookies",
        "Crackers",
        "Cream",
        "Cream Cheese",
        "Customer Reward Programs",
        "Deli Dips / Ready to Serve",
        "Dishwashing Liquid",
        "Disinfectant Sprays",
        "Dog Biscuits Or Treats",
        "Dog Food",
        "Drug Stores",
        "Dust / Dirt Cleaning System",
        "Eggs",
        "Fabric Refreshers",
        "Facial Tissues",
        "Flavoured & Seasoned Rice",
        "Food Delivery Services",
        "Food Shopping",
        "Footwear",
        "Frozen Fish",
        "Frozen Meals",
        "Frozen Pizza",
        "Frozen Pizza Snacks",
        "Frozen Potato Products (i.e. French fries, Potato wedges, Hash browns)",
        "Frozen Vegetables",
        "Fruit Juices & Drinks",
        "Granola / Cereal Bars",
        "Greeting Cards",
        "Grocery Delivery Providers",
        "Household Cleaners",
        "Ice Cream / Ice Milk / Sherbet & Frozen Yogurt",
        "Instant Breakfast / Breakfast Shakes",
        "Instant Hot Cereals",
        "Jewellery",
        "Ketchup",
        "Lactose Free Dairy Products",
        "Laundry Stain Removers",
        "Margarine",
        "Mayonnaise / Mayonnaise Type Salad Dressing",
        "Meal Kits Delivery Services",
        "Men's Clothing",
        "Milk",
        "Milk Alternatives",
        "Natural Cheese",
        "Online Shipping Services",
        "Orange Juice",
        "Organic Foods",
        "Paper Napkins",
        "Paper Towels",
        "Pasta",
        "Pasta Sauce",
        "Peanut Butter",
        "Pet Food Where Bought",
        "Pet Ownership",
        "Plain Rice",
        "Plastic Food Containers",
        "Plastic Storage Bags",
        "Processed Cheese",
        "Rolled Oats / Oatmeal / Hot Cereals",
        "Salad Dressing",
        "Salad / Cooking Oil",
        "Salsa",
        "Shopping In-Store / Online",
        "Shopping Malls, Centres or Districts",
        "Soap & Detergents For Fine Fabrics",
        "Soap & Detergents For Regular Laundry",
        "Soup",
        "Spreads",
        "Toaster Products",
        "Toilet Paper",
        "Tomato And Vegetable Juices",
        "Toys & Games",
        "Vegan / Plant Based Packaged Products",
        "Women's Clothing",
        "Yogurt"
    ]
}

from selenium import webdriver
from selenium.webdriver.chrome.service import Service as ChromeService
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from webdriver_manager.chrome import ChromeDriverManager
from selenium.common.exceptions import TimeoutException
import time
from dotenv import load_dotenv
import os
import requests
import pickle
from selenium.common.exceptions import StaleElementReferenceException
from selenium.common.exceptions import NoSuchElementException
from selenium.webdriver.common.action_chains import ActionChains
from selenium.webdriver.common.by import By

load_dotenv()
ARIMA_USER = os.getenv("ARIMA_USER")
ARIMA_PASS = os.getenv("ARIMA_PASS")

chrome_options = Options()
chrome_options.add_argument("--ignore-certificate-errors")
# chrome_options.add_argument("user-data-dir=selenium")
chrome_options.add_argument("--headless")
chrome_options.add_argument("window-size=3840x2160")

prefs = {"download.default_directory" : "C:\\Users\\MSadm\\Documents\\Sadman\\code\\arima\\arima-cli\\data"}
chrome_options.add_experimental_option("prefs",prefs)
print("Setup options")

driver = webdriver.Chrome(
    service=ChromeService(ChromeDriverManager().install()),
    options=chrome_options
)

driver.get("https://arimadata.com/account")

time.sleep(1)

wait = WebDriverWait(driver, 180)

if driver.current_url == "https://arimadata.com/account":
    login_found = wait.until(EC.presence_of_all_elements_located((By.XPATH, "//*[contains(text(), 'Log In')]")))

    if login_found:
        print("Login screen found")
        # Find the input field and type "user"
        input_field = driver.find_element(By.ID, "outlined-email")
        input_field.send_keys(ARIMA_USER)

        # Find the password field and type "password"
        password_field = driver.find_element(By.ID, "outlined-password")
        password_field.send_keys(ARIMA_PASS)

        # Find the login button and click it
        login_button = driver.find_element(By.XPATH, "//button[contains(text(), 'Log In')]")
        login_button.click()

        print("Clicked login button")

time.sleep(1)

driver.get("https://arimadata.com/dashboard/module")

def click_with_custom_wait(driver, wait, xpath):
    max_attempts = 5
    for attempt in range(max_attempts):
        try:
            element = wait.until(EC.presence_of_element_located((By.XPATH, xpath)))
            element.click()
            print("Clicked on element with XPath:", xpath)
            break
        except StaleElementReferenceException:
            if attempt == max_attempts - 1:  # Re-raise the last exception if max attempts reached
                raise
            continue

# Wait for "Persona Builder" to show up and then click on it
click_with_custom_wait(driver, wait, "//div[contains(text(), 'Persona Builder')]")
print("4")

click_with_custom_wait(driver, wait, "//div[contains(text(), 'General')]")
print("5")

general_audience = wait.until(EC.presence_of_element_located((By.XPATH, "//div[contains(text(), 'General')]")))
general_audience.click()
print("5")

select_audience = driver.find_element(By.XPATH, "//button[contains(text(), 'Select Audience')]")
select_audience.click()
print("6")

audience_crosstab = wait.until(EC.element_to_be_clickable((By.XPATH, "//div[contains(text(), 'Audience Crosstab')]")))
audience_crosstab.click()
print("1")

try:
    WebDriverWait(driver, 180).until(EC.invisibility_of_element_located((By.XPATH, "//*[contains(text(), 'Please wait while we compile your audience')]")))
except TimeoutException:
    print("Timed out waiting for 'Please wait' text to disappear")

def get_theme_or_cat(driver, wait, theme_name):
    theme = None
    theme_found = False
    while not theme_found:
        try:
            theme = wait.until(EC.presence_of_element_located((By.XPATH, "//div[contains(@class, 'MuiGrid-root') and contains(@class, 'MuiGrid-container') and contains(@class, 'MuiGrid-wrap-xs-nowrap') and contains(@class, 'css-7ftst8')]//p[contains(text(), '" + theme_name + "')]")))
            actions = ActionChains(driver)
            actions.move_to_element(theme).perform()
            driver.execute_script("arguments[0].click();", theme)
            theme_found = True
        except StaleElementReferenceException:
            continue
    return theme

def get_all_texts(driver, base_selector):
    i = 1
    texts = []
    while True:
        try:
            element = driver.find_element(By.CSS_SELECTOR, f"{base_selector}:nth-child({i})")
            actions = ActionChains(driver)
            actions.move_to_element(element).perform()
            texts.append(element.text)
        except:
            break
        i += 1
    return texts

start_theme = False
start_cat = False
with open("words.txt", "w") as file:
    for theme in themes:
        if theme == "Health and Wellness":
            start_theme = True
        if not start_theme:
            continue
        print("theme = ", theme, file=file)
        curr_theme = get_theme_or_cat(driver, wait, theme)
        # time.sleep(4)
        for category in categories[theme]:
            if category == "Make":
                start_cat = True
            if not start_cat:
                continue
            print("category = ", category, file=file)
            curr_cat = get_theme_or_cat(driver, wait, category)
            # time.sleep(4)
            texts = get_all_texts(driver, ".css-wo8ext")
            print("texts = ", texts, file=file)
            actions = ActionChains(driver)
            actions.move_to_element(curr_cat).perform()
            driver.execute_script("arguments[0].click();", curr_cat)
        actions = ActionChains(driver)
        actions.move_to_element(curr_theme).perform()
        driver.execute_script("arguments[0].click();", curr_theme)

# theme = "Demography"
# theme = "Health and Wellness"
theme = "Shopping"
if theme not in themes:
    print(f"Theme {theme} not found")
    exit(1)

# category = "Household Status"
# category = "Acne Products"
category = "Deli Dips / Ready to Serve"
if category not in categories[theme]:
    print(f"Category {category} not found")
    exit(1)

get_theme_or_cat(driver, wait, theme)
get_theme_or_cat(driver, wait, category)

print("Selected theme and category")

def find_nth_child_with_text(driver, base_selector, text):
    i = 1
    while True:
        try:
            element = driver.find_element(By.CSS_SELECTOR, f"{base_selector}:nth-child({i})")
            print("i = ", i)
            print("element.text = ", element.text)
            if text in element.text:
                return element
        except:
            return None
        i += 1

def click_nth_child_with_text(driver, base_selector, text):
    element = find_nth_child_with_text(driver, base_selector, text)
    if element is not None:
        print("Element found: ", text)
        element.click()
    else:
        print("Element not found")


# click_nth_child_with_text(driver, ".css-wo8ext", "Head of Household")
# click_nth_child_with_text(driver, ".css-wo8ext", "Grandparent")

texts = get_all_texts(driver, ".css-wo8ext")
print("texts = ", texts)
time.sleep(10)
click_nth_child_with_text(driver, ".css-wo8ext", "# of Containers Used In Hhld. In Past Month")
time.sleep(10)
click_nth_child_with_text(driver, ".css-wo8ext", "# of Times Used Snack - Packs in Past Month")
time.sleep(10)

print("BOTH CHECKBOXES CLICKED")
time.sleep(3)

analyze_button = driver.find_element(By.CSS_SELECTOR, ".MuiButton-contained")
analyze_button.click()
print("11")
print("CLICKED ANALYZE BUTTON")
time.sleep(3)

try:
    WebDriverWait(driver, 180).until(EC.invisibility_of_element_located((By.XPATH, "//*[contains(text(), 'Please wait while we compile your audience')]")))
except TimeoutException:
    print("Timed out waiting for 'Please wait' text to disappear")

import datetime

# check if `data/Demographic_Deep_Dive_All_Tables.csv` exists
# if it does, append current timestamp to end of filename
old_file_name = "data/Demographic_Deep_Dive_All_Tables.csv"
timestamp = datetime.datetime.now().strftime("%Y_%m_%d-%H_%M_%S")
new_file_name = "data/Demographic_Deep_Dive_All_Tables_" + timestamp + ".csv"

if os.path.exists(old_file_name):
    os.rename(old_file_name, new_file_name)
else:
    print(f"{old_file_name} not found.")

extract_all_tables = driver.find_element(By.CSS_SELECTOR, "div:nth-child(2) > .MuiButton-root")
extract_all_tables.click()
print("CLICKED EXPORT BUTTON")

extract_all_tables = driver.find_element(By.CSS_SELECTOR, ".MuiMenuItem-root > a")
extract_all_tables.click()
print("CLICKED DOWNLOAD BUTTON")

old_file_name = "data/Demographic_Deep_Dive_All_Tables.csv"

timestamp = datetime.datetime.now().strftime("%Y\_%m\_%d-%H\_%M\_%S")
new_file_name = f"data/data_{timestamp}.csv"

if os.path.exists(old_file_name):
    os.rename(old_file_name, new_file_name)
else:
    print(f"{old_file_name} not found.")

time.sleep(1)

# click on edit table variables
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

button = WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.CSS_SELECTOR, ".MuiButton-outlined")))

driver.execute_script("arguments[0].click();", button)

# button = WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.CSS_SELECTOR, ".MuiButton-outlined")))
# button.click()

# button = driver.find_element(By.CSS_SELECTOR, ".MuiButton-outlined")
# button.click()

# wait to go back to variable selection screen
try:
    WebDriverWait(driver, 180).until(EC.invisibility_of_element_located((By.XPATH, "//*[contains(text(), 'Please wait while we compile your audience')]")))
except TimeoutException:
    print("Timed out waiting for 'Please wait' text to disappear")

time.sleep(1)

from selenium.common.exceptions import NoSuchElementException

def find_div_with_text(driver, base_xpath, text, display=False):
    try:
        element = driver.find_element(By.XPATH, f"{base_xpath}")
        if display: print("0 ", element.text)
        if text in element.text:
            return element
    except NoSuchElementException:
        pass

    i = 2
    while True:
        try:
            element = driver.find_element(By.XPATH, f"{base_xpath}[{i}]")
            if display: print(i, " ", element.text)
            if text in element.text:
                return element
        except NoSuchElementException:
            return None
        i += 1

def click_div_with_text(driver, base_xpath, text):
    element = find_div_with_text(driver, "//div[3]/div[3]/div", text)
    if element is not None:
        print("Element found: ", text)
        element.click()
    else:
        print("Element not found")

print("preclick")
click_div_with_text(driver, "//div[3]/div[3]/div", "Grandparent")
click_div_with_text(driver, "//div[3]/div[3]/div", "Head of Household")

time.sleep(30)

driver.close()
driver.quit()

# <a download="Demographic_Deep_Dive_All_Tables.csv" target="_self" href="blob:" style="color: inherit; text-decoration: none;">Extract All Tables to CSV</a>